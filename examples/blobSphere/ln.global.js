"use strict";var ln=(()=>{var $=Object.defineProperty;var tt=Object.getOwnPropertyDescriptor;var it=Object.getOwnPropertyNames;var st=Object.prototype.hasOwnProperty;var et=(o,t)=>{for(var i in t)$(o,i,{get:t[i],enumerable:!0})},rt=(o,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of it(t))!st.call(o,e)&&e!==i&&$(o,e,{get:()=>t[e],enumerable:!(s=tt(t,e))||s.enumerable});return o};var nt=o=>rt($({},"__esModule",{value:!0}),o);var ot={};et(ot,{Core:()=>Q,Math:()=>_,Shapes:()=>L});var h=class o{constructor(t,i,s){this.X=t,this.Y=i,this.Z=s}static RandomUnitVector(){for(;;){let t=Math.random()*2-1,i=Math.random()*2-1,s=Math.random()*2-1;if(!(t*t+i*i+s*s>1))return new o(t,i,s).Normalize()}}Length(){return Math.sqrt(this.X*this.X+this.Y*this.Y+this.Z*this.Z)}Distance(t){return this.Sub(t).Length()}LengthSquared(){return this.X*this.X+this.Y*this.Y+this.Z*this.Z}DistanceSquared(t){return this.Sub(t).LengthSquared()}Dot(t){return this.X*t.X+this.Y*t.Y+this.Z*t.Z}Cross(t){let i=this.Y*t.Z-this.Z*t.Y,s=this.Z*t.X-this.X*t.Z,e=this.X*t.Y-this.Y*t.X;return new o(i,s,e)}Normalize(){let t=this.Length();return new o(this.X/t,this.Y/t,this.Z/t)}Add(t){return new o(this.X+t.X,this.Y+t.Y,this.Z+t.Z)}Sub(t){return new o(this.X-t.X,this.Y-t.Y,this.Z-t.Z)}Mul(t){return new o(this.X*t.X,this.Y*t.Y,this.Z*t.Z)}Div(t){return new o(this.X/t.X,this.Y/t.Y,this.Z/t.Z)}AddScalar(t){return new o(this.X+t,this.Y+t,this.Z+t)}SubScalar(t){return new o(this.X-t,this.Y-t,this.Z-t)}MulScalar(t){return new o(this.X*t,this.Y*t,this.Z*t)}DivScalar(t){return new o(this.X/t,this.Y/t,this.Z/t)}Min(t){return new o(Math.min(this.X,t.X),Math.min(this.Y,t.Y),Math.min(this.Z,t.Z))}Max(t){return new o(Math.max(this.X,t.X),Math.max(this.Y,t.Y),Math.max(this.Z,t.Z))}MinAxis(){let t=Math.abs(this.X),i=Math.abs(this.Y),s=Math.abs(this.Z);return t<=i&&t<=s?new o(1,0,0):i<=t&&i<=s?new o(0,1,0):new o(0,0,1)}MinComponent(){return Math.min(Math.min(this.X,this.Y),this.Z)}SegmentDistance(t,i){let s=t.DistanceSquared(i);if(s===0)return this.Distance(t);let e=this.Sub(t).Dot(i.Sub(t))/s;return e<0?this.Distance(t):e>1?this.Distance(i):t.Add(i.Sub(t).MulScalar(e)).Distance(this)}};var R=(e=>(e[e.AxisNone=0]="AxisNone",e[e.AxisX=1]="AxisX",e[e.AxisY=2]="AxisY",e[e.AxisZ=3]="AxisZ",e))(R||{});var l=class o{constructor(t,i){this.Min=t,this.Max=i}static BoxForTriangles(t){if(t.length===0)return new o(new h(0,0,0),new h(0,0,0));let i=t[0].BoundingBox();for(let s=1;s<t.length;s++)i=i.Extend(t[s].BoundingBox());return i}static BoxForShapes(t){if(t.length===0)return new o(new h(0,0,0),new h(0,0,0));let i=t[0].BoundingBox();for(let s of t)i=i.Extend(s.BoundingBox());return i}static BoxForVectors(t){if(t.length===0)return new o(new h(0,0,0),new h(0,0,0));let i=t[0],s=t[0];for(let e of t)i=i.Min(e),s=s.Max(e);return new o(i,s)}Anchor(t){return this.Min.Add(this.Size().Mul(t))}Center(){return this.Anchor(new h(.5,.5,.5))}Size(){return this.Max.Sub(this.Min)}Contains(t){return this.Min.X<=t.X&&this.Max.X>=t.X&&this.Min.Y<=t.Y&&this.Max.Y>=t.Y&&this.Min.Z<=t.Z&&this.Max.Z>=t.Z}Extend(t){return new o(this.Min.Min(t.Min),this.Max.Max(t.Max))}Intersect(t){let i=(this.Min.X-t.Origin.X)/t.Direction.X,s=(this.Min.Y-t.Origin.Y)/t.Direction.Y,e=(this.Min.Z-t.Origin.Z)/t.Direction.Z,r=(this.Max.X-t.Origin.X)/t.Direction.X,n=(this.Max.Y-t.Origin.Y)/t.Direction.Y,a=(this.Max.Z-t.Origin.Z)/t.Direction.Z;return i>r&&([i,r]=[r,i]),s>n&&([s,n]=[n,s]),e>a&&([e,a]=[a,e]),[Math.max(Math.max(i,s),e),Math.min(Math.min(r,n),a)]}Partition(t,i){let[s,e]=[!1,!1];switch(t){case 1:s=this.Min.X<=i,e=this.Max.X>=i;break;case 2:s=this.Min.Y<=i,e=this.Max.Y>=i;break;case 3:s=this.Min.Z<=i,e=this.Max.Z>=i;break}return[s,e]}};var S=class o extends Array{static FromVectors(t){let i=new o;return i.push(...t),i}BoundingBox(){return l.BoxForVectors(this)}Transform(t){let i=new o;for(let s of this)i.push(t.MulPosition(s));return i}Chop(t){let i=new o;for(let s=0;s<this.length-1;s++){let e=this[s],r=this[s+1],n=r.Sub(e),a=n.Length();s===0&&i.push(e);let x=t;for(;x<a;)i.push(e.Add(n.MulScalar(x/a))),x+=t;i.push(r)}return i}Filter(t){let i=new f,s=new o;for(let e of this){let[r,n]=t.Filter(e);n?s.push(r):(s.length>1&&i.push(s),s=new o)}return s.length>1&&i.push(s),i}Simplify(t){if(this.length<3)return this;let i=this[0],s=this[this.length-1],e=-1,r=0;for(let n=1;n<this.length-1;n++){let a=this[n].SegmentDistance(i,s);a>r&&(e=n,r=a)}if(r>t){let n=new o(...this.slice(0,e+1)).Simplify(t),a=new o(...this.slice(e)).Simplify(t);return new o(...n.slice(0,n.length-1).concat(a))}else return new o(i,s)}};var f=class o extends Array{static FromVectors(t){let i=new o;for(let s of t)i.push(S.FromVectors(s));return i}static FromPaths(t){let i=new o;return i.push(...t),i}BoundingBox(){let t=this[0].BoundingBox();for(let i of this)t=t.Extend(i.BoundingBox());return t}Transform(t){let i=new o;for(let s of this)i.push(s.Transform(t));return i}Chop(t){let i=new o;for(let s of this)i.push(s.Chop(t));return i}Filter(t){let i=new o;for(let s of this)i.push(...s.Filter(t));return i}Simplify(t){let i=new o;for(let s of this)i.push(s.Simplify(t));return i}};var D=class{constructor(){}Compile(){}BoundingBox(){return new l(new h(0,0,0),new h(0,0,0))}Contains(t,i){return!1}Intersect(t){return p.NoHit()}Paths(){return new f}};var A=class{constructor(t,i){this.Shape=t,this.Matrix=i,this.Inverse=this.Matrix.Inverse()}Compile(){this.Shape.Compile()}BoundingBox(){return this.Matrix.MulBox(this.Shape.BoundingBox())}Contains(t,i){return this.Shape.Contains(this.Inverse.MulPosition(t),i)}Intersect(t){return this.Shape.Intersect(this.Inverse.MulRay(t))}Paths(){return this.Shape.Paths().Transform(this.Matrix)}};var F=class{constructor(t,i){this.Min=t,this.Max=i,this.Box=new l(this.Min,this.Max)}Compile(){}BoundingBox(){return this.Box}Contains(t,i){return t.X<this.Min.X-i||t.X>this.Max.X+i||t.Y<this.Min.Y-i||t.Y>this.Max.Y+i?!1:!(t.Z<this.Min.Z-i||t.Z>this.Max.Z+i)}Intersect(t){let i=this.Min.Sub(t.Origin).Div(t.Direction),s=this.Max.Sub(t.Origin).Div(t.Direction);[i,s]=[i.Min(s),i.Max(s)];let e=Math.max(i.X,i.Y,i.Z),r=Math.min(s.X,s.Y,s.Z);return e<.001&&r>.001?new p(this,r):e>=.001&&e<r?new p(this,e):p.NoHit()}Paths(){let[t,i,s]=[this.Min.X,this.Min.Y,this.Min.Z],[e,r,n]=[this.Max.X,this.Max.Y,this.Max.Z];return f.FromVectors([[new h(t,i,s),new h(t,i,n)],[new h(t,i,s),new h(t,r,s)],[new h(t,i,s),new h(e,i,s)],[new h(t,i,n),new h(t,r,n)],[new h(t,i,n),new h(e,i,n)],[new h(t,r,s),new h(t,r,n)],[new h(t,r,s),new h(e,r,s)],[new h(t,r,n),new h(e,r,n)],[new h(e,i,s),new h(e,i,n)],[new h(e,i,s),new h(e,r,s)],[new h(e,i,n),new h(e,r,n)],[new h(e,r,s),new h(e,r,n)]])}};var b=class{constructor(t,i){this.Origin=t,this.Direction=i}Position(t){return this.Origin.Add(this.Direction.MulScalar(t))}};var q=class{constructor(t){this.CsgShape=t}Filter(t){return[t,this.CsgShape.Contains(t,0)]}},H=class o{constructor(t,i,s){this.ShapeA=t,this.ShapeB=i,this.Operation=s}static Intersection(t,i){return new o(t,i,0)}static Difference(t,i){return new o(t,i,1)}static Union(t,i){return new o(t,i,2)}Compile(){}BoundingBox(){let t=this.ShapeA.BoundingBox(),i=this.ShapeB.BoundingBox();switch(this.Operation){case 0:return new l(t.Min.Max(i.Min),t.Max.Min(i.Max));case 1:return t;case 2:return t.Extend(i)}}Contains(t,i){switch(i=.001,this.Operation){case 0:return this.ShapeA.Contains(t,i)&&this.ShapeB.Contains(t,i);case 1:return this.ShapeA.Contains(t,i)&&!this.ShapeB.Contains(t,-i);case 2:return this.ShapeA.Contains(t,i)||this.ShapeB.Contains(t,i)}return!1}Intersect(t){let i=this.ShapeA.Intersect(t),s=this.ShapeB.Intersect(t),e=i.Min(s),r=t.Position(e.T);return!e.Ok()||this.Contains(r,0)?e:this.Intersect(new b(t.Position(e.T+.01),t.Direction))}Paths(){let t=this.ShapeA.Paths();return t.push(...this.ShapeB.Paths()),t.Chop(.01).Filter(new q(this))}};function I(o){return o*Math.PI/180}function K(o){return o*180/Math.PI}function Y(o){let t=o.length;if(t===0)return 0;if(t%2===1)return o[Math.floor(t/2)];{let i=o[t/2-1],s=o[t/2];return(i+s)/2}}function j(o,t,i){return[o,t]=[I(o),I(t)],new h(i*Math.cos(o)*Math.cos(t),i*Math.cos(o)*Math.sin(t),i*Math.sin(o))}var z=class o{constructor(t,i,s){this.Function=t,this.Box=i,this.Direction=s}static Above(t,i){return new o(t,i,0)}static Below(t,i){return new o(t,i,1)}Compile(){}BoundingBox(){return this.Box}Contains(t,i){return this.Direction===1?t.Z<this.Function(t.X,t.Y):t.Z>this.Function(t.X,t.Y)}Intersect(t){let i=.015625,s=this.Contains(t.Position(i),0);for(let e=i;e<10;e+=i){let r=t.Position(e);if(this.Contains(r,0)!=s&&this.Box.Contains(r))return new p(this,e)}return p.NoHit()}Paths(){let t=new f,i=1/256;for(let s=0;s<360;s+=5){let e=new S;for(let r=0;r<=8;r+=i){let n=Math.cos(I(s))*r,a=Math.sin(I(s))*r,x=this.Function(n,a),u=-Math.pow(-x,1.4);e.push(new h(Math.cos(I(s)-u)*r,Math.sin(I(s)-u)*r,Math.max(Math.min(x,this.Box.Max.Z),this.Box.Min.Z)))}t.push(e)}return t}};var O=class{constructor(t,i){this.Center=t,this.Radius=i,this.Box=new l(new h(this.Center.X-this.Radius,this.Center.Y-this.Radius,this.Center.Z-this.Radius),new h(this.Center.X+this.Radius,this.Center.Y+this.Radius,this.Center.Z+this.Radius))}Compile(){}BoundingBox(){return this.Box}Contains(t,i){return t.Sub(this.Center).Length()<=this.Radius+i}Intersect(t){let i=this.Radius,s=t.Origin.Sub(this.Center),e=s.Dot(t.Direction),r=s.Dot(s)-i*i,n=e*e-r;if(n>0){n=Math.sqrt(n);let a=-e-n;if(a>.01)return new p(this,a);let x=-e+n;if(x>.01)return new p(this,x)}return p.NoHit()}Paths(){let t=new f,i=10,s=10;for(let e=-90+s;e<=90-s;e+=i){let r=new S;for(let n=0;n<=360;n++)r.push(j(e,n,this.Radius).Add(this.Center));t.push(r)}for(let e=0;e<=360;e+=i){let r=new S;for(let n=-90+s;n<=90-s;n++)r.push(j(n,e,this.Radius).Add(this.Center));t.push(r)}return t}};var X=class{constructor(t,i,s){this.V1=t,this.V2=i,this.V3=s,this.Box=new l(new h(0,0,0),new h(0,0,0)),this.UpdateBoundingBox()}UpdateBoundingBox(){this.Box.Min=this.V1.Min(this.V2).Min(this.V3),this.Box.Max=this.V1.Max(this.V2).Max(this.V3)}Compile(){}BoundingBox(){return this.Box}Contains(t,i){return!1}Intersect(t){let i=this.V2.X-this.V1.X,s=this.V2.Y-this.V1.Y,e=this.V2.Z-this.V1.Z,r=this.V3.X-this.V1.X,n=this.V3.Y-this.V1.Y,a=this.V3.Z-this.V1.Z,x=t.Direction.Y*a-t.Direction.Z*n,u=t.Direction.Z*r-t.Direction.X*a,c=t.Direction.X*n-t.Direction.Y*r,m=i*x+s*u+e*c;if(m>-1e-6&&m<1e-6)return p.NoHit();let M=1/m,g=t.Origin.X-this.V1.X,B=t.Origin.Y-this.V1.Y,P=t.Origin.Z-this.V1.Z,V=(g*x+B*u+P*c)*M;if(V<0||V>1)return p.NoHit();let d=B*e-P*s,T=P*i-g*e,W=g*s-B*i,G=(t.Direction.X*d+t.Direction.Y*T+t.Direction.Z*W)*M;if(G<0||V+G>1)return p.NoHit();let J=(r*d+n*T+a*W)*M;return J<1e-6?p.NoHit():new p(this,J)}Paths(){let t=new f;return t.push(S.FromVectors([this.V1,this.V2])),t.push(S.FromVectors([this.V2,this.V3])),t.push(S.FromVectors([this.V3,this.V1])),t}};var N=class{constructor(t,i,s){this.Radius=t,this.Z0=i,this.Z1=s,this.Box=new l(new h(-this.Radius,-this.Radius,this.Z0),new h(this.Radius,this.Radius,this.Z1))}Compile(){}BoundingBox(){return this.Box}Contains(t,i){return new h(t.X,t.Y,0).Length()>this.Radius+i?!1:t.Z>=this.Z0-i&&t.Z<=this.Z1+i}Intersect(t){let i=this.Radius,s=t.Origin,e=t.Direction,r=e.X*e.X+e.Y*e.Y,n=2*s.X*e.X+2*s.Y*e.Y,a=s.X*s.X+s.Y*s.Y-i*i,x=n*n-4*r*a;if(x<0)return p.NoHit();let u=Math.sqrt(x),c=(-n+u)/(2*r),m=(-n-u)/(2*r);c>m&&([c,m]=[m,c]);let M=s.Z+c*e.Z,g=s.Z+m*e.Z;return c>1e-6&&this.Z0<M&&M<this.Z1?new p(this,c):m>1e-6&&this.Z0<g&&g<this.Z1?new p(this,m):p.NoHit()}Paths(){let t=new f;for(let i=0;i<360;i+=10){let s=this.Radius*Math.cos(I(i)),e=this.Radius*Math.sin(I(i));t.push(S.FromVectors([new h(s,e,this.Z0),new h(s,e,this.Z1)]))}return t}};var w=class o{constructor(t,i,s,e,r,n,a,x,u,c,m,M,g,B,P,V){this.x00=t,this.x01=i,this.x02=s,this.x03=e,this.x10=r,this.x11=n,this.x12=a,this.x13=x,this.x20=u,this.x21=c,this.x22=m,this.x23=M,this.x30=g,this.x31=B,this.x32=P,this.x33=V}static Zero(){return new o(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}static Identity(){return new o(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}static Translate(t){return new o(1,0,0,t.X,0,1,0,t.Y,0,0,1,t.Z,0,0,0,1)}static Scale(t){return new o(t.X,0,0,0,0,t.Y,0,0,0,0,t.Z,0,0,0,0,1)}static Rotate(t,i){let s=t.Normalize(),e=Math.sin(i),r=Math.cos(i),n=1-r;return new o(n*s.X*s.X+r,n*s.X*s.Y+s.Z*e,n*s.Z*s.X-s.Y*e,0,n*s.X*s.Y-s.Z*e,n*s.Y*s.Y+r,n*s.Y*s.Z+s.X*e,0,n*s.Z*s.X+s.Y*e,n*s.Y*s.Z-s.X*e,n*s.Z*s.Z+r,0,0,0,0,1)}static Frustum(t,i,s,e,r,n){let a=2*r,x=i-t,u=e-s,c=n-r;return new o(a/x,0,(i+t)/x,0,0,a/u,(e+s)/u,0,0,0,(-n-r)/c,-a*n/c,0,0,-1,0)}static Orthographic(t,i,s,e,r,n){return new o(2/(i-t),0,0,-(i+t)/(i-t),0,2/(e-s),0,-(e+s)/(e-s),0,0,-2/(n-r),-(n+r)/(n-r),0,0,0,1)}static Perspective(t,i,s,e){let r=s*Math.tan(t*Math.PI/360),n=r*i;return this.Frustum(-n,n,-r,r,s,e)}static LookAt(t,i,s){let e=s.Normalize(),r=i.Sub(t).Normalize(),n=r.Cross(s).Normalize(),a=n.Cross(r).Normalize();return new o(n.X,a.X,-r.X,t.X,n.Y,a.Y,-r.Y,t.Y,n.Z,a.Z,-r.Z,t.Z,0,0,0,1).Inverse()}Translate(t){return o.Translate(t).Mul(this)}Scale(t){return o.Scale(t).Mul(this)}Rotate(t,i){return o.Rotate(t,i).Mul(this)}Frustum(t,i,s,e,r,n){return o.Frustum(t,i,s,e,r,n).Mul(this)}Orthographic(t,i,s,e,r,n){return o.Orthographic(t,i,s,e,r,n).Mul(this)}Perspective(t,i,s,e){return o.Perspective(t,i,s,e).Mul(this)}Mul(t){let i=o.Identity();return i.x00=this.x00*t.x00+this.x01*t.x10+this.x02*t.x20+this.x03*t.x30,i.x10=this.x10*t.x00+this.x11*t.x10+this.x12*t.x20+this.x13*t.x30,i.x20=this.x20*t.x00+this.x21*t.x10+this.x22*t.x20+this.x23*t.x30,i.x30=this.x30*t.x00+this.x31*t.x10+this.x32*t.x20+this.x33*t.x30,i.x01=this.x00*t.x01+this.x01*t.x11+this.x02*t.x21+this.x03*t.x31,i.x11=this.x10*t.x01+this.x11*t.x11+this.x12*t.x21+this.x13*t.x31,i.x21=this.x20*t.x01+this.x21*t.x11+this.x22*t.x21+this.x23*t.x31,i.x31=this.x30*t.x01+this.x31*t.x11+this.x32*t.x21+this.x33*t.x31,i.x02=this.x00*t.x02+this.x01*t.x12+this.x02*t.x22+this.x03*t.x32,i.x12=this.x10*t.x02+this.x11*t.x12+this.x12*t.x22+this.x13*t.x32,i.x22=this.x20*t.x02+this.x21*t.x12+this.x22*t.x22+this.x23*t.x32,i.x32=this.x30*t.x02+this.x31*t.x12+this.x32*t.x22+this.x33*t.x32,i.x03=this.x00*t.x03+this.x01*t.x13+this.x02*t.x23+this.x03*t.x33,i.x13=this.x10*t.x03+this.x11*t.x13+this.x12*t.x23+this.x13*t.x33,i.x23=this.x20*t.x03+this.x21*t.x13+this.x22*t.x23+this.x23*t.x33,i.x33=this.x30*t.x03+this.x31*t.x13+this.x32*t.x23+this.x33*t.x33,i}MulPosition(t){let i=this.x00*t.X+this.x01*t.Y+this.x02*t.Z+this.x03,s=this.x10*t.X+this.x11*t.Y+this.x12*t.Z+this.x13,e=this.x20*t.X+this.x21*t.Y+this.x22*t.Z+this.x23;return new h(i,s,e)}MulPositionW(t){let i=this.MulPosition(t),s=this.x30*t.X+this.x31*t.Y+this.x32*t.Z+this.x33;return i.DivScalar(s)}MulDirection(t){let i=this.x00*t.X+this.x01*t.Y+this.x02*t.Z,s=this.x10*t.X+this.x11*t.Y+this.x12*t.Z,e=this.x20*t.X+this.x21*t.Y+this.x22*t.Z;return new h(i,s,e).Normalize()}MulRay(t){return new b(this.MulPosition(t.Origin),this.MulDirection(t.Direction))}MulBox(t){let i=new h(this.x00,this.x10,this.x20),s=new h(this.x01,this.x11,this.x21),e=new h(this.x02,this.x12,this.x22),r=new h(this.x03,this.x13,this.x23),n=i.MulScalar(t.Min.X),a=i.MulScalar(t.Max.X),x=s.MulScalar(t.Min.Y),u=s.MulScalar(t.Max.Y),c=e.MulScalar(t.Min.Z),m=e.MulScalar(t.Max.Z);return[n,a]=[n.Min(a),n.Max(a)],[x,u]=[x.Min(u),x.Max(u)],[c,m]=[c.Min(m),c.Max(m)],new l(n.Add(x).Add(c).Add(r),a.Add(u).Add(m).Add(r))}Transpose(){return new o(this.x00,this.x10,this.x20,this.x30,this.x01,this.x11,this.x21,this.x31,this.x02,this.x12,this.x22,this.x32,this.x03,this.x13,this.x23,this.x33)}Determinant(){return this.x00*this.x11*this.x22*this.x33-this.x00*this.x11*this.x23*this.x32+this.x00*this.x12*this.x23*this.x31-this.x00*this.x12*this.x21*this.x33+this.x00*this.x13*this.x21*this.x32-this.x00*this.x13*this.x22*this.x31-this.x01*this.x12*this.x23*this.x30+this.x01*this.x12*this.x20*this.x33-this.x01*this.x13*this.x20*this.x32+this.x01*this.x13*this.x22*this.x30-this.x01*this.x10*this.x22*this.x33+this.x01*this.x10*this.x23*this.x32+this.x02*this.x13*this.x20*this.x31-this.x02*this.x13*this.x21*this.x30+this.x02*this.x10*this.x21*this.x33-this.x02*this.x10*this.x23*this.x31+this.x02*this.x11*this.x23*this.x30-this.x02*this.x11*this.x20*this.x33-this.x03*this.x10*this.x21*this.x32+this.x03*this.x10*this.x22*this.x31-this.x03*this.x11*this.x22*this.x30+this.x03*this.x11*this.x20*this.x32-this.x03*this.x12*this.x20*this.x31+this.x03*this.x12*this.x21*this.x30}Inverse(){let t=this.Determinant();return new o((this.x12*this.x23*this.x31-this.x13*this.x22*this.x31+this.x13*this.x21*this.x32-this.x11*this.x23*this.x32-this.x12*this.x21*this.x33+this.x11*this.x22*this.x33)/t,(this.x03*this.x22*this.x31-this.x02*this.x23*this.x31-this.x03*this.x21*this.x32+this.x01*this.x23*this.x32+this.x02*this.x21*this.x33-this.x01*this.x22*this.x33)/t,(this.x02*this.x13*this.x31-this.x03*this.x12*this.x31+this.x03*this.x11*this.x32-this.x01*this.x13*this.x32-this.x02*this.x11*this.x33+this.x01*this.x12*this.x33)/t,(this.x03*this.x12*this.x21-this.x02*this.x13*this.x21-this.x03*this.x11*this.x22+this.x01*this.x13*this.x22+this.x02*this.x11*this.x23-this.x01*this.x12*this.x23)/t,(this.x13*this.x22*this.x30-this.x12*this.x23*this.x30-this.x13*this.x20*this.x32+this.x10*this.x23*this.x32+this.x12*this.x20*this.x33-this.x10*this.x22*this.x33)/t,(this.x02*this.x23*this.x30-this.x03*this.x22*this.x30+this.x03*this.x20*this.x32-this.x00*this.x23*this.x32-this.x02*this.x20*this.x33+this.x00*this.x22*this.x33)/t,(this.x03*this.x12*this.x30-this.x02*this.x13*this.x30-this.x03*this.x10*this.x32+this.x00*this.x13*this.x32+this.x02*this.x10*this.x33-this.x00*this.x12*this.x33)/t,(this.x02*this.x13*this.x20-this.x03*this.x12*this.x20+this.x03*this.x10*this.x22-this.x00*this.x13*this.x22-this.x02*this.x10*this.x23+this.x00*this.x12*this.x23)/t,(this.x11*this.x23*this.x30-this.x13*this.x21*this.x30+this.x13*this.x20*this.x31-this.x10*this.x23*this.x31-this.x11*this.x20*this.x33+this.x10*this.x21*this.x33)/t,(this.x03*this.x21*this.x30-this.x01*this.x23*this.x30-this.x03*this.x20*this.x31+this.x00*this.x23*this.x31+this.x01*this.x20*this.x33-this.x00*this.x21*this.x33)/t,(this.x01*this.x13*this.x30-this.x03*this.x11*this.x30+this.x03*this.x10*this.x31-this.x00*this.x13*this.x31-this.x01*this.x10*this.x33+this.x00*this.x11*this.x33)/t,(this.x03*this.x11*this.x20-this.x01*this.x13*this.x20-this.x03*this.x10*this.x21+this.x00*this.x13*this.x21+this.x01*this.x10*this.x23-this.x00*this.x11*this.x23)/t,(this.x12*this.x21*this.x30-this.x11*this.x22*this.x30-this.x12*this.x20*this.x31+this.x10*this.x22*this.x31+this.x11*this.x20*this.x32-this.x10*this.x21*this.x32)/t,(this.x01*this.x22*this.x30-this.x02*this.x21*this.x30+this.x02*this.x20*this.x31-this.x00*this.x22*this.x31-this.x01*this.x20*this.x32+this.x00*this.x21*this.x32)/t,(this.x02*this.x11*this.x30-this.x01*this.x12*this.x30-this.x02*this.x10*this.x31+this.x00*this.x12*this.x31+this.x01*this.x10*this.x32-this.x00*this.x11*this.x32)/t,(this.x01*this.x12*this.x20-this.x02*this.x11*this.x20+this.x02*this.x10*this.x21-this.x00*this.x12*this.x21-this.x01*this.x10*this.x22+this.x00*this.x11*this.x22)/t)}};var v=class o{constructor(t){this.Triangles=t,this.Box=l.BoxForTriangles(t)}static FromObjString(t){let i=[],s=[];for(let e of t.split(`
`)){let r=e.trim().split(" ");if(r.length<2)continue;switch(r[0]){case"v":i.push(new h(parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3])));break;case"f":let a=[];for(let x=1;x<r.length;x++)a.push(parseInt(r[x].split("/")[0]));for(let x=1;x<a.length-1;x++)console.log(a[0]-1,a[x]-1,a[x+1]-1),s.push(new X(i[a[0]-1],i[a[x]-1],i[a[x+1]-1]));break}}return new o(s)}Compile(){this.Tree===void 0&&(this.Tree=new Z(this.Triangles))}BoundingBox(){return this.Box}Contains(t,i){return!1}Intersect(t){return this.Tree?this.Tree.Intersect(t):p.NoHit()}Paths(){let t=new f;for(let i of this.Triangles)t.push(...i.Paths());return t}UpdateBoundingBox(){this.Box=l.BoxForTriangles(this.Triangles)}UnitCube(){this.FitInside(new l(new h(0,0,0),new h(1,1,1)),new h(0,0,0)),this.MoveTo(new h(0,0,0),new h(.5,.5,.5))}MoveTo(t,i){this.Transform(w.Translate(t.Sub(this.Box.Anchor(i))))}FitInside(t,i){let s=t.Size().Div(this.BoundingBox().Size()).MinComponent(),e=t.Size().Sub(this.BoundingBox().Size().MulScalar(s));this.Transform(w.Identity().Translate(this.BoundingBox().Min.MulScalar(-1)).Scale(new h(s,s,s)).Translate(t.Min.Add(e.Mul(i))))}Transform(t){for(let i=0;i<this.Triangles.length;i++)this.Triangles[i].V1=t.MulPosition(this.Triangles[i].V1),this.Triangles[i].V2=t.MulPosition(this.Triangles[i].V2),this.Triangles[i].V3=t.MulPosition(this.Triangles[i].V3),this.Triangles[i].UpdateBoundingBox();this.UpdateBoundingBox(),this.Tree=void 0}};var E=class o{constructor(t,i,s,e){this.Triangles=t,this.Edges=i,this.Eye=s,this.Box=l.BoxForTriangles(t),this.SilhouetteEpsilon=e}static FromMesh(t,i,s,e){let r=[],n={};for(let a=0;a<i.length;a++){let x=[i[a].i1,i[a].i2,i[a].i3];r.push(new X(t[x[0]],t[x[1]],t[x[2]]));for(let u=0;u<3;u++){let[c,m]=[x[u],x[(u+1)%3]];m<c&&([c,m]=[m,c]),`${c}-${m}`in n?n[`${c}-${m}`].t2Index=r.length-1:n[`${c}-${m}`]={t1Index:r.length-1,t2Index:-1,t1VIndex:u}}}return new o(r,n,s,e)}static FromObjString(t,i,s){let e=[],r={},n=[];for(let a of t.split(`
`)){let x=a.trim().split(" ");if(x.length<2)continue;switch(x[0]){case"v":e.push(new h(parseFloat(x[1]),parseFloat(x[2]),parseFloat(x[3])));break;case"f":let c=[];for(let m=1;m<x.length;m++)c.push(parseInt(x[m].split("/")[0]));for(let m=1;m<c.length-1;m++){let M=[c[0]-1,c[m]-1,c[m+1]-1],[g,B,P]=[e[M[0]],e[M[1]],e[M[2]]];n.push(new X(g,B,P));for(let V=0;V<3;V++){let[d,T]=[M[V],M[(V+1)%3]];T<d&&([d,T]=[T,d]),`${d}-${T}`in r?r[`${d}-${T}`].t2Index=n.length-1:r[`${d}-${T}`]={t1Index:n.length-1,t2Index:-1,t1VIndex:V}}}break}}return new o(n,r,i,s)}Compile(){this.Tree===void 0&&(this.Tree=new Z(this.Triangles))}BoundingBox(){return this.Box}Contains(t,i){return!1}Intersect(t){return this.Tree?this.Tree.Intersect(t):p.NoHit()}Paths(){let t=new f;for(let i of Object.keys(this.Edges)){let s=this.Eye.Normalize(),e=this.SilhouetteEpsilon,r=this.Triangles[this.Edges[i].t1Index],n=[r.V1,r.V2,r.V3],a=this.Edges[i].t1VIndex,[x,u]=[n[a],n[(a+1)%3]],c=r.V2.Sub(r.V1).Cross(r.V3.Sub(r.V1)).Normalize(),m=s.Dot(c);if(this.Edges[i].t2Index!==-1){let M=this.Triangles[this.Edges[i].t2Index],g=M.V2.Sub(M.V1).Cross(M.V3.Sub(M.V1)).Normalize(),B=s.Dot(g);(m>=-e&&B<=e||m<=e&&B>=-e)&&t.push(S.FromVectors([x,u]))}else t.push(S.FromVectors([x,u]))}return t}UpdateBoundingBox(){this.Box=l.BoxForTriangles(this.Triangles)}UnitCube(){this.FitInside(new l(new h(0,0,0),new h(1,1,1)),new h(0,0,0)),this.MoveTo(new h(0,0,0),new h(.5,.5,.5))}MoveTo(t,i){this.Transform(w.Translate(t.Sub(this.Box.Anchor(i))))}FitInside(t,i){let s=t.Size().Div(this.BoundingBox().Size()).MinComponent(),e=t.Size().Sub(this.BoundingBox().Size().MulScalar(s));this.Transform(w.Identity().Translate(this.BoundingBox().Min.MulScalar(-1)).Scale(new h(s,s,s)).Translate(t.Min.Add(e.Mul(i))))}Transform(t){for(let i=0;i<this.Triangles.length;i++)this.Triangles[i].V1=t.MulPosition(this.Triangles[i].V1),this.Triangles[i].V2=t.MulPosition(this.Triangles[i].V2),this.Triangles[i].V3=t.MulPosition(this.Triangles[i].V3),this.Triangles[i].UpdateBoundingBox();this.UpdateBoundingBox(),this.Tree=void 0}};var L={EmptyShape:D,TransformShape:A,BoxShape:F,CsgShape:H,FunctionShape:z,SphereShape:O,TriangleShape:X,CylinderShape:N,MeshShape:v,SilhouetteMeshShape:E};var p=class o{constructor(t,i){this.Shape=t,this.T=i}static NoHit(){return new o(new L.EmptyShape,1/0)}Ok(){return this.T<1/0}Min(t){return this.T<=t.T?this:t}Max(t){return this.T>t.T?this:t}};var y=class o{constructor(t){this.Axis=0,this.Point=0,this.Shapes=t,this.Left=void 0,this.Right=void 0}Intersect(t,i,s){let e,r;switch(this.Axis){case 0:return this.IntersectShapes(t);case 1:e=(this.Point-t.Origin.X)/t.Direction.X,r=t.Origin.X<this.Point||t.Origin.X===this.Point&&t.Direction.X<=0;break;case 2:e=(this.Point-t.Origin.Y)/t.Direction.Y,r=t.Origin.Y<this.Point||t.Origin.Y===this.Point&&t.Direction.Y<=0;break;case 3:e=(this.Point-t.Origin.Z)/t.Direction.Z,r=t.Origin.Z<this.Point||t.Origin.Z===this.Point&&t.Direction.Z<=0;break;default:throw new Error("Unknown axis")}let n=r?this.Left:this.Right,a=r?this.Right:this.Left;if(!n||!a)return p.NoHit();if(e>s||e<=0)return n.Intersect(t,i,s);if(e<i)return a.Intersect(t,i,s);{let x=n.Intersect(t,i,e);if(x.T<=e)return x;let u=a.Intersect(t,e,Math.min(s,x.T));return x.T<=u.T?x:u}}IntersectShapes(t){let i=p.NoHit();for(let s of this.Shapes){let e=s.Intersect(t);e.T<i.T&&(i=e)}return i}PartitionScore(t,i){let s=0,e=0;for(let r of this.Shapes){let n=r.BoundingBox(),[a,x]=n.Partition(t,i);a&&s++,x&&e++}return Math.max(s,e)}Partition(t,i,s){let e=[],r=[];for(let n of this.Shapes){let a=n.BoundingBox(),[x,u]=a.Partition(i,s);x&&e.push(n),u&&r.push(n)}return[e,r]}Split(t){if(this.Shapes.length<8)return;let i=[],s=[],e=[];for(let V of this.Shapes){let d=V.BoundingBox();i.push(d.Min.X,d.Max.X),s.push(d.Min.Y,d.Max.Y),e.push(d.Min.Z,d.Max.Z)}i.sort((V,d)=>V-d),s.sort((V,d)=>V-d),e.sort((V,d)=>V-d);let r=Y(i),n=Y(s),a=Y(e),x=Math.floor(this.Shapes.length*.85),u=0,c=0,m=this.PartitionScore(1,r);m<x&&(x=m,u=1,c=r);let M=this.PartitionScore(2,n);M<x&&(x=M,u=2,c=n);let g=this.PartitionScore(3,a);if(g<x&&(x=g,u=3,c=a),u===0)return;let[B,P]=this.Partition(x,u,c);this.Axis=u,this.Point=c,this.Left=new o(B),this.Right=new o(P),this.Left.Split(t+1),this.Right.Split(t+1),this.Shapes=[]}};var Z=class{constructor(t){this.Box=l.BoxForShapes(t),this.Root=new y(t),this.Root.Split(0)}Intersect(t){let[i,s]=this.Box.Intersect(t);return s<i||s<=0?p.NoHit():this.Root.Intersect(t,i,s)}};var k=class k{constructor(t,i,s){this.Matrix=t;this.Eye=i;this.Scene=s}Filter(t){let i=this.Matrix.MulPositionW(t);return this.Scene.Visible(this.Eye,t)?k.ClipBox.Contains(i)?[i,!0]:[i,!1]:[i,!1]}};k.ClipBox=new l(new h(-1,-1,-1),new h(1,1,1));var C=k;var U=class{constructor(){this.Shapes=[]}Compile(){for(let t of this.Shapes)t.Compile();this.Tree===void 0&&(this.Tree=new Z(this.Shapes))}Add(t){this.Shapes.push(t)}Intersect(t){return this.Tree?this.Tree.Intersect(t):p.NoHit()}Visible(t,i){let s=t.Sub(i),e=new b(i,s.Normalize());return this.Intersect(e).T>=s.Length()}Paths(){let t=new f;for(let i of this.Shapes)t.push(...i.Paths());return t}Render(t,i,s,e,r,n,a,x,u){let c=w.LookAt(t,i,s).Perspective(n,e/r,a,x);return this.RenderWithMatrix(c,t,e,r,u)}RenderWithMatrix(t,i,s,e,r){this.Compile();let n=this.Paths();return r>0&&(n=n.Chop(r)),n=n.Filter(new C(t,i,this)),r>0&&(n=n.Simplify(1e-6)),n=n.Transform(w.Translate(new h(1,-1,0)).Scale(new h(s/2,-e/2,0))),n}};var Q={ClipFilter:C,Scene:U};var _={Axis:R,Box:l,Degrees:K,Hit:p,Matrix:w,Median:Y,Node:y,Path:S,Paths:f,Radians:I,Ray:b,Tree:Z,Vector:h};return nt(ot);})();
